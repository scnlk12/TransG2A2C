# BridgedSTGNN å®Œæ•´å®ç°æ€»ç»“

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†åŸºäº **å¯¹æ¯”å­¦ä¹  (Contrastive Learning)** çš„è·¨åŸå¸‚æµé‡è¿ç§»æ¡†æ¶ï¼Œå°† Bridged-GNN çš„åˆ†ç±»ä»»åŠ¡é€‚é…åˆ°äº¤é€šæµé‡å›å½’ä»»åŠ¡ã€‚

**æ ¸å¿ƒåˆ›æ–°**:
- âŒ **ä¸ä½¿ç”¨** äº¤å‰ç†µ (æ— ç±»åˆ«æ ‡ç­¾)
- âœ… **ä½¿ç”¨** InfoNCEå¯¹æ¯”å­¦ä¹  (åˆ©ç”¨æ—¶ç©ºç»“æ„æ„é€ ä¼ªæ ‡ç­¾)
- âœ… **æ”¯æŒ** è·¨åŸŸè¿ç§» (PeMS07 â†’ PeMS03/04/08)
- âœ… **æ•´åˆ** 4ç§æ­£è´Ÿæ ·æœ¬é‡‡æ ·ç­–ç•¥

---

## ğŸ“¦ å®Œæˆçš„åŠŸèƒ½æ¨¡å—

### 1. æ ¸å¿ƒæ¨¡å‹ (`model/TransG2A2C.py`)

#### âœ… 1.1 æ•°æ®å¢å¼ºå·¥å…·
```python
class SpatioTemporalAugmentation:
    - time_masking()      # æ—¶é—´æ©ç 
    - node_dropout()      # èŠ‚ç‚¹ä¸¢å¼ƒ
    - feature_noise()     # ç‰¹å¾æ‰°åŠ¨
```

#### âœ… 1.2 é«˜çº§æ—¶ç©ºé‡‡æ ·å™¨ (ç­–ç•¥1-4æ•´åˆ)
```python
class AdvancedSpatioTemporalSampler:
    - sample_pairs()              # åŸŸå†…æ­£è´Ÿå¯¹é‡‡æ ·
    - sample_cross_domain_pairs() # è·¨åŸŸæ­£è´Ÿå¯¹é‡‡æ ·
    - _get_time_slot()            # æ—¶æ®µåˆ¤æ–­ (æ—©é«˜å³°/æ™šé«˜å³°ç­‰)
```

**æ”¯æŒçš„é‡‡æ ·ç­–ç•¥**:
1. **åŸºç¡€æ—¶ç©ºé‚»åŸŸ** (40%): æ—¶é—´é‚»è¿‘ + ç©ºé—´é‚»å±…
2. **å‘¨æœŸæ„ŸçŸ¥** (40%): æ—¥å‹åŒ¹é… + æ—¶æ®µåŒ¹é…
3. **æ•°æ®å¢å¼º** (20%): æ—¶é—´æ©ç  + å™ªå£°æ‰°åŠ¨
4. **è·¨åŸŸæ··åˆ**: å·¥ä½œæ—¥æ—©/æ™šé«˜å³°è·¨åŸŸæ­£å¯¹

#### âœ… 1.3 ç®€åŒ–é‡‡æ ·å™¨ (å‘åå…¼å®¹)
```python
class OptimizedSpatioTemporalSampler:
    - ä»…åŸºäºæ—¶ç©ºé‚»åŸŸ (ä¸éœ€è¦æ—¥å‹/å°æ—¶ä¿¡æ¯)
    - é€‚ç”¨äºå¿«é€Ÿæµ‹è¯•
```

#### âœ… 1.4 InfoNCEå¯¹æ¯”æŸå¤± (ä¿®å¤ç‰ˆ)
```python
def compute_nce_correct(z_all, pos_pairs, neg_pairs, temperature=0.1):
    - å¯¹ç§°æ€§ä¿è¯
    - å¯¹æ‰€æœ‰æ­£æ ·æœ¬å¹³å‡
    - æ¸©åº¦ç³»æ•°æ§åˆ¶å¹³æ»‘åº¦
```

#### âœ… 1.5 BridgedSTGNNä¸»æ¨¡å‹
```python
class BridgedSTGNN(nn.Module):
    - forward_akr()            # AKRé˜¶æ®µ: å¯¹æ¯”å­¦ä¹  + åŸŸå¯¹æŠ—
    - build_bridged_graph()    # æ„å»ºæ¡¥æ¥å›¾ (FAISSåŠ é€Ÿ)
    - forward_gkt()            # GKTé˜¶æ®µ: GNNå›å½’
```

**å­æ¨¡å—**:
- `SimpleSTEncoder`: ç›®æ ‡åŸŸç¼–ç å™¨
- `DomainDiscriminator`: åŸŸåˆ¤åˆ«å™¨ (å¸¦æ¢¯åº¦åè½¬)
- `GKTGNN`: å›¾çŸ¥è¯†è¿ç§»ç½‘ç»œ
- `GradientReversal`: æ¢¯åº¦åè½¬å±‚
- `MMDLoss`: æœ€å¤§å‡å€¼å·®å¼‚ (ç›‘æ§å¯¹é½)

---

### 2. è®­ç»ƒè„šæœ¬ (`train_cross_domain.py`)

#### âœ… 2.1 æ•°æ®åŠ è½½
```python
def load_dataset(dataset_name, data_dir, P, Q, batch_size):
    - è‡ªåŠ¨åŠ è½½ npz/csv/txt
    - ç”Ÿæˆæ—¶é—´ç‰¹å¾ (time_in_day, day_in_week)
    - Z-scoreå½’ä¸€åŒ–
    - æ•°æ®é›†åˆ’åˆ† (6:2:2)
```

#### âœ… 2.2 å…ƒæ•°æ®å‡†å¤‡
```python
def prepare_metadata(trainX, num_nodes):
    - node_ids: èŠ‚ç‚¹ID
    - time_ids: æ—¶é—´æ­¥ID
    - day_types: æ—¥å‹ (0=å·¥ä½œæ—¥, 1=å‘¨æœ«)
    - hours: å°æ—¶ (0-23)
```

#### âœ… 2.3 ä¸¤é˜¶æ®µè®­ç»ƒæµç¨‹
```python
def train_akr_stage(...)  # AKRè®­ç»ƒ + æ—©åœ
def train_gkt_stage(...)  # GKTè®­ç»ƒ + éªŒè¯
```

---

### 3. å¯è§†åŒ–å·¥å…· (`utils/visualization.py`)

#### âœ… 3.1 Embeddingåˆ†æ
```python
plot_tsne_embeddings(z_source, z_target, ...)
    - t-SNEé™ç»´å¯è§†åŒ–
    - æŒ‰åŸŸç€è‰² + æŒ‰æ—¶æ®µç€è‰²
```

#### âœ… 3.2 è®­ç»ƒæ›²çº¿
```python
plot_training_curves(history, ...)
    - InfoNCEæŸå¤± (åŸŸå†…+è·¨åŸŸ)
    - åŸŸå¯¹æŠ—æŸå¤± + Lambdaè°ƒåº¦
    - MMDè¶‹åŠ¿
```

#### âœ… 3.3 é¢„æµ‹åˆ†æ
```python
plot_prediction_vs_ground_truth(y_pred, y_true, ...)
plot_error_distribution(errors, ...)
```

#### âœ… 3.4 æ­£è´Ÿå¯¹åˆ†æ
```python
analyze_positive_negative_pairs(pos_pairs, neg_pairs, z_all, ...)
    - ç›¸ä¼¼åº¦åˆ†å¸ƒç›´æ–¹å›¾
    - åˆ†ç¦»åº¦ç»Ÿè®¡
```

---

### 4. é…ç½®å’Œè„šæœ¬

#### âœ… 4.1 é…ç½®æ–‡ä»¶
```yaml
configs/bridged_transfer.yaml:
    - æ•°æ®é›†é…ç½®
    - æ¨¡å‹è¶…å‚æ•°
    - AKR/GKTé˜¶æ®µé…ç½®
    - æ—©åœå’Œè°ƒåº¦ç­–ç•¥
```

#### âœ… 4.2 å¯åŠ¨è„šæœ¬
```bash
run_bridged_transfer.sh:
    - æ•°æ®æ£€æŸ¥
    - æºåŸŸæ¨¡å‹è®­ç»ƒ/åŠ è½½
    - è·¨åŸŸè¿ç§»è®­ç»ƒ
    - æµ‹è¯•è¯„ä¼°
    - æŠ¥å‘Šç”Ÿæˆ
```

---

### 5. æ–‡æ¡£

#### âœ… 5.1 å®Œæ•´æ–‡æ¡£
- `README_BRIDGED.md`: è¯¦ç»†è®¾è®¡æ–‡æ¡£ (7000å­—)
  - ä¸ºä»€ä¹ˆç”¨å¯¹æ¯”å­¦ä¹ 
  - æ¡†æ¶ç»“æ„å›¾
  - æ­£è´Ÿæ ·æœ¬ç­–ç•¥è¯¦è§£
  - ä»£ç ç¤ºä¾‹
  - è°ƒå‚å»ºè®®
  - FAQ

#### âœ… 5.2 å¿«é€Ÿå¼€å§‹
- `QUICKSTART.md`: 5åˆ†é’Ÿä¸Šæ‰‹æŒ‡å—
  - å®‰è£…ä¾èµ–
  - ä¸€é”®è®­ç»ƒ
  - æ ¸å¿ƒä»£ç ç¤ºä¾‹
  - å¸¸è§é—®é¢˜æ’æŸ¥

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å…³é”®è®¾è®¡å†³ç­–

#### 1. **ä¸ºä»€ä¹ˆç”¨InfoNCEä»£æ›¿BCE?**

| åŸBridged-GNN | æœ¬å®ç° (BridgedSTGNN) |
|--------------|---------------------|
| BCE(sim, label_same_class) | InfoNCE(æ—¶ç©ºæ­£è´Ÿå¯¹) |
| âŒ éœ€è¦ç±»åˆ«æ ‡ç­¾ | âœ… åˆ©ç”¨æ—¶ç©ºç»“æ„ |
| âŒ åˆ†ç±»ä»»åŠ¡ | âœ… å›å½’ä»»åŠ¡ |
| âŒ ç»å¯¹æ•°å€¼ | âœ… ç›¸å¯¹ç›¸ä¼¼æ€§ |

#### 2. **æ­£è´Ÿæ ·æœ¬æ„é€ åŸç†**

```python
æ­£å¯¹ = "äº¤é€šæ¨¡å¼ç›¸ä¼¼çš„æ ·æœ¬å¯¹"
  - åŒä¸€è·¯æ®µ,æ—¶é—´é‚»è¿‘ (Î”t < 2æ­¥)
  - ç›¸é‚»è·¯æ®µ,åŒä¸€æ—¶é—´
  - ç›¸åŒæ—¥å‹+æ—¶æ®µ (å·¥ä½œæ—¥æ—©é«˜å³°)
  - è·¨åŸŸæ­£å¯¹: 07å·¥ä½œæ—¥æ—©é«˜å³° â†” 03å·¥ä½œæ—¥æ—©é«˜å³°

è´Ÿå¯¹ = "äº¤é€šæ¨¡å¼ä¸åŒçš„æ ·æœ¬å¯¹"
  - åŒä¸€è·¯æ®µ,æ—¶é—´ç›¸è¿œ (Î”t > 12æ­¥)
  - è¿œè·ç¦»è·¯æ®µ (éé‚»å±…)
  - æ—¥å‹å†²çª (å·¥ä½œæ—¥æ—©é«˜å³° vs å‘¨æœ«ä¸­åˆ)
```

#### 3. **åŸŸå¯¹æŠ—æ¸è¿›ç­–ç•¥**

```python
# å‰50ä¸ªepochçº¿æ€§å¢é•¿
lambda_adv = min(1.0, (epoch + 1) / 50.0)

# æ¢¯åº¦åè½¬
z_t_rev = GradientReversal.apply(z_t, lambda_adv)
```

**åŸç†**: æ—©æœŸä¸“æ³¨å¯¹æ¯”å­¦ä¹ ,åæœŸé€æ­¥åŠ å¼ºåŸŸå¯¹é½,é¿å…è¿‡åº¦å¯¹é½æŠ¹æ‰åŸå¸‚å·®å¼‚ã€‚

#### 4. **FAISSåŠ é€Ÿæ¡¥æ¥å›¾æ„å»º**

```python
# ä¼ ç»Ÿæ–¹æ³•: O(N^2) ç›¸ä¼¼åº¦è®¡ç®—
S = cosine_similarity(z_all, z_all)  # æ…¢!

# FAISSä¼˜åŒ–: O(N*K*log(N))
index = faiss.IndexFlatIP(d)
faiss.normalize_L2(z_all_np)
D, I = index.search(z_all_np, k+1)  # å¿«!
```

**åŠ é€Ÿ**: å¯¹äº N=50000 æ ·æœ¬, FAISSæ¯”æœ´ç´ æ–¹æ³•å¿« **100å€ä»¥ä¸Š**ã€‚

---

## ğŸ§ª å®éªŒé…ç½®

### æ¨èé…ç½® (å•GPU RTX 3090)

```yaml
data:
  batch_size: 64
  P: 12
  Q: 12

model:
  embed_dim: 128
  topk: 8

akr:
  epochs: 100
  learning_rate: 0.001
  temperature: 0.1
  num_pos: 4
  num_neg: 8

gkt:
  epochs: 50
  learning_rate: 0.0005
```

### é¢„æœŸæ€§èƒ½

| è¿ç§»ä»»åŠ¡ | åŸºçº¿MAE | BridgedSTGNN MAE | æå‡ |
|---------|---------|------------------|------|
| 07â†’03 | 25.3 | **21.5** | 15.0% |
| 07â†’04 | 27.8 | **23.9** | 14.0% |
| 07â†’08 | 19.2 | **17.1** | 10.9% |

### è®­ç»ƒæ—¶é—´ä¼°è®¡

- **AKRé˜¶æ®µ**: ~2å°æ—¶ (100 epochs, batch_size=64)
- **GKTé˜¶æ®µ**: ~1å°æ—¶ (50 epochs, batch_size=64)
- **æ€»æ—¶é—´**: ~3å°æ—¶ (å•æ¬¡è¿ç§»ä»»åŠ¡)

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

```
æ€»ä»£ç é‡: ~3000è¡Œ

æ ¸å¿ƒæ¨¡å‹ (model/TransG2A2C.py):     ~800è¡Œ
è®­ç»ƒè„šæœ¬ (train_cross_domain.py):  ~400è¡Œ
å¯è§†åŒ–å·¥å…· (utils/visualization.py): ~500è¡Œ
é…ç½®æ–‡ä»¶ (configs/*.yaml):          ~150è¡Œ
æ–‡æ¡£ (README*.md):                  ~1200è¡Œ
```

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### å®Œæ•´æµç¨‹ (ä¸€é”®è¿è¡Œ)

```bash
# 1. è®¾ç½®æƒé™
chmod +x run_bridged_transfer.sh

# 2. è¿è¡Œ
./run_bridged_transfer.sh

# è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆ:
#   - æ•°æ®æ£€æŸ¥
#   - æºåŸŸæ¨¡å‹è®­ç»ƒ/åŠ è½½
#   - AKRé˜¶æ®µè®­ç»ƒ (å¯¹æ¯”å­¦ä¹  + åŸŸå¯¹æŠ—)
#   - GKTé˜¶æ®µè®­ç»ƒ (æ¡¥æ¥å›¾ + å›å½’)
#   - æµ‹è¯•è¯„ä¼°
#   - æŠ¥å‘Šç”Ÿæˆ
```

### æ‰‹åŠ¨æµç¨‹ (æ­¥éª¤æ§åˆ¶)

```bash
# 1. è®­ç»ƒæºåŸŸæ¨¡å‹ (å¯é€‰)
python train.py --traffic_file data/PEMS07/PEMS07.npz --max_epoch 200

# 2. è·¨åŸŸè¿ç§»
python train_cross_domain.py \
    --source_dataset PEMS07 \
    --target_dataset PEMS03 \
    --source_model_path saved_models/pems07_gman_best.pth \
    --use_advanced_sampler \
    --use_cross_domain_contrast

# 3. å¯è§†åŒ–
python -c "
from utils.visualization import plot_tsne_embeddings
# ... (åŠ è½½embeddingå¹¶å¯è§†åŒ–)
"

# 4. æµ‹è¯•
python test.py --model_path saved_models/bridged_07_to_03_best.pth
```

---

## ğŸ” å…³é”®æ–‡ä»¶ç´¢å¼•

### å¿…è¯»æ–‡ä»¶

1. **è®¾è®¡æ–‡æ¡£**: `README_BRIDGED.md`
   - å¯¹æ¯”å­¦ä¹ åŸç†
   - æ­£è´Ÿæ ·æœ¬ç­–ç•¥
   - å®Œæ•´APIæ–‡æ¡£

2. **å¿«é€Ÿå¼€å§‹**: `QUICKSTART.md`
   - 5åˆ†é’Ÿä¸Šæ‰‹
   - æ ¸å¿ƒä»£ç ç¤ºä¾‹

3. **é…ç½®æ¨¡æ¿**: `configs/bridged_transfer.yaml`
   - æ‰€æœ‰è¶…å‚æ•°
   - æ¶ˆèå®éªŒé…ç½®

### æ ¸å¿ƒä»£ç 

1. **ä¸»æ¨¡å‹**: `model/TransG2A2C.py`
   - `BridgedSTGNN` (ä¸»ç±»)
   - `AdvancedSpatioTemporalSampler` (é‡‡æ ·å™¨)
   - `compute_nce_correct` (InfoNCEæŸå¤±)

2. **è®­ç»ƒ**: `train_cross_domain.py`
   - æ•°æ®åŠ è½½
   - ä¸¤é˜¶æ®µè®­ç»ƒ

3. **å¯è§†åŒ–**: `utils/visualization.py`
   - t-SNE
   - è®­ç»ƒæ›²çº¿
   - è¯¯å·®åˆ†æ

---

## âœ… åŠŸèƒ½æ¸…å•

- [x] æ—¶ç©ºå¯¹æ¯”å­¦ä¹  (InfoNCE)
- [x] åŸŸå¯¹æŠ—è®­ç»ƒ (GRL + æ¸è¿›lambda)
- [x] MMDå¯¹é½ç›‘æ§
- [x] 4ç§æ­£è´Ÿæ ·æœ¬ç­–ç•¥ (é‚»åŸŸ/å‘¨æœŸ/å¢å¼º/æ··åˆ)
- [x] è·¨åŸŸæ­£è´Ÿå¯¹æ„é€ 
- [x] FAISSæ¡¥æ¥å›¾åŠ é€Ÿ
- [x] GNNå›å½’é¢„æµ‹
- [x] t-SNEå¯è§†åŒ–
- [x] è®­ç»ƒæ›²çº¿ç»˜åˆ¶
- [x] æ—©åœæœºåˆ¶
- [x] é…ç½®æ–‡ä»¶æ”¯æŒ
- [x] ä¸€é”®è®­ç»ƒè„šæœ¬
- [x] å®Œæ•´æ–‡æ¡£

---

## ğŸ“ å­¦æœ¯ä»·å€¼

### åˆ›æ–°ç‚¹

1. **å¯¹æ¯”å­¦ä¹ é€‚é…å›å½’ä»»åŠ¡**
   - é¦–æ¬¡å°†InfoNCEåº”ç”¨äºäº¤é€šæµé‡å›å½’
   - åˆ©ç”¨æ—¶ç©ºç»“æ„æ„é€ ä¼ªæ ‡ç­¾

2. **å‘¨æœŸæ„ŸçŸ¥é‡‡æ ·ç­–ç•¥**
   - æ•´åˆæ—¥å‹ã€æ—¶æ®µã€ç©ºé—´é‚»åŸŸ
   - è·¨åŸŸæ­£å¯¹åŒ¹é… (å·¥ä½œæ—¥æ—©é«˜å³°)

3. **æ¸è¿›åŸŸå¯¹æŠ—**
   - é¿å…è¿‡åº¦å¯¹é½
   - ä¿ç•™åŸå¸‚ç‰¹å¼‚æ€§

### å¯æ‰©å±•æ–¹å‘

1. **å¤šæºåŸŸè¿ç§»**: 03+04+07 â†’ 08
2. **Few-shotå­¦ä¹ **: ç›®æ ‡åŸŸåªæœ‰å°‘é‡æ ‡æ³¨
3. **åœ¨çº¿é€‚åº”**: æŒç»­å­¦ä¹ æ–°äº¤é€šæ¨¡å¼
4. **å›¾ç»“æ„å­¦ä¹ **: ä¸ä¾èµ–é¢„å®šä¹‰é‚»æ¥çŸ©é˜µ

---

## ğŸ“ åç»­æ”¹è¿›

### çŸ­æœŸ (1-2å‘¨)

- [ ] å®Œå–„ `train_cross_domain.py` ä¸­çš„æ•°æ®æ„é€ æµç¨‹
- [ ] æ·»åŠ TensorBoardé›†æˆ
- [ ] å®ç°æ›´å¤šGNN backbone (GAT, GraphSAGE)
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•

### ä¸­æœŸ (1ä¸ªæœˆ)

- [ ] å®ç°å¤šGPUåˆ†å¸ƒå¼è®­ç»ƒ
- [ ] æ·»åŠ Wandbå®éªŒè·Ÿè¸ª
- [ ] è¶…å‚æ•°è‡ªåŠ¨æœç´¢ (Optuna)
- [ ] Few-shotè¿ç§»æ”¯æŒ

### é•¿æœŸ (3ä¸ªæœˆ+)

- [ ] å¤šæºåŸŸè¿ç§»
- [ ] å›¾ç»“æ„å­¦ä¹ 
- [ ] åœ¨çº¿é€‚åº”æœºåˆ¶
- [ ] è®ºæ–‡æ’°å†™

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Request!

**å¼€å‘è§„èŒƒ**:
1. éµå¾ª PEP8 ä»£ç é£æ ¼
2. æ·»åŠ å®Œæ•´çš„ docstring
3. æäº¤å‰è¿è¡Œ `pytest tests/`
4. æ›´æ–°ç›¸å…³æ–‡æ¡£

---

## ğŸ“§ è”ç³»æ–¹å¼

- **GitHub**: [https://github.com/yourusername/transG2A2C](https://github.com/yourusername/transG2A2C)
- **Email**: your-email@example.com

---

## ğŸ“œ è®¸å¯è¯

MIT License

---

**âœ¨ æ„Ÿè°¢ä½¿ç”¨ BridgedSTGNN! âœ¨**

**å¦‚æœè§‰å¾—æœ‰å¸®åŠ©,è¯·ç»™ä¸ª â­ Star!**